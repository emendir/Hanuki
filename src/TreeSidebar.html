<!DOCTYPE html>

<head>
  <style>
    body {
      /* font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; */
      margin: 0;
      padding: 10px;
      color: #333;
    }

    #explorer {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .tree-item {
      padding: 3px 0;
      margin: 2px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .tree-folder {
      font-weight: 500;
    }
    
    /* Aligning both files and folders to the same left margin */
    .tree-folder, .tree-file {
      margin-left: 0;
    }
    
    .tree-folder-content {
      border-left: 1px solid #ccc;
      margin-left: 8px;
      padding-left: 20px;
      display: none;
    }
    
    .tree-folder-content.active {
      display: block;
    }
    
    .folder-icon, .file-icon {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-right: 5px;
      text-align: center;
    }
    
    .folder-icon:before {
      content: 'â–¶';
      font-size: 12px;
    }
    
    .folder-icon.expanded:before {
      content: 'â–¼';
    }
    
    .file-icon:before {
      content: 'ðŸ“„';
      font-size: 12px;
      opacity: 0;
    }
    
    /* Hover effect for items */
    .tree-item:hover {
      background-color: rgba(0, 0, 0, 0.05);
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <div id="file-explorer">
    <ul id="explorer" class="tree-root"></ul>
  </div>

  <script>
    // Main function to initialize the tree
    async function initFileExplorer() {
      const rootElement = document.getElementById('explorer');
      
      try {
        // Start building the tree from the ProjectFiles directory
        await buildTreeNode(rootElement, '');
      } catch (error) {
        console.error('Error initializing file explorer:', error);
      }
    }
    
    // Check if a path is a directory by trying to list its contents
    async function isDirectory(path) {
      try {
        const contents = await parent.listProjectDir(path);
        return contents && contents.length > 0;
      } catch (error) {
        return false;
      }
    }
    
    // Function to build a tree node and its children recursively
    async function buildTreeNode(parentElement, dirPath) {
      try {
        // Call the parent window's listProjectDir function
        const filePaths = await parent.listProjectDir(dirPath);
        
        if (!filePaths || filePaths.length === 0) {
          console.log('No files found in:', dirPath);
          return;
        }
        
        // Extract unique items from the current directory level
        const items = new Map();
        
        for (const path of filePaths) {
          // Extract the relative path after /ProjectFiles/
          const relativePath = path.split('/ProjectFiles/')[1];
          if (!relativePath) continue;
          
          // Handle path with proper folder structure
          const pathParts = relativePath.split('/').filter(part => part);
          
          if (pathParts.length === 0) continue;
          
          // If we're at the root, just take the first part
          // If we're in a subfolder, compare with the current dirPath
          let itemName;
          let itemPath;
          
          if (!dirPath) {
            // At root level
            itemName = pathParts[0];
            itemPath = itemName;
          } else {
            // In a subfolder - extract the next part after the current dirPath
            const dirParts = dirPath.split('/').filter(part => part);
            if (pathParts.length <= dirParts.length) continue;
            
            itemName = pathParts[dirParts.length];
            itemPath = dirPath + '/' + itemName;
          }
          
          // Skip if we've already processed this item
          if (items.has(itemName)) continue;
          
          // Add to items map
          items.set(itemName, itemPath);
        }
        
        // Create containers for folders and files so we can display folders first
        const folderElements = [];
        const fileElements = [];
        
        // Process each item, checking if it's a directory or file
        for (const [itemName, itemPath] of items) {
          const isDir = await isDirectory(itemPath);
          
          if (isDir) {
            // Create folder element
            const folderItem = document.createElement('li');
            folderItem.className = 'tree-item tree-folder';
            
            const folderIcon = document.createElement('span');
            folderIcon.className = 'folder-icon';
            
            const folderName = document.createElement('span');
            folderName.textContent = itemName;
            
            folderItem.appendChild(folderIcon);
            folderItem.appendChild(folderName);
            
            // Create a container for folder contents
            const folderContent = document.createElement('ul');
            folderContent.className = 'tree-folder-content';
            
            // Add click handler to toggle folder expansion
            folderItem.addEventListener('click', function(event) {
              event.stopPropagation();
              folderIcon.classList.toggle('expanded');
              folderContent.classList.toggle('active');
              
              // Only load contents the first time the folder is expanded
              if (folderContent.dataset.loaded !== 'true') {
                buildTreeNode(folderContent, itemPath);
                folderContent.dataset.loaded = 'true';
              }
            });
            
            // Add folder item and its content container to the list
            folderElements.push({ folderItem, folderContent });
          } else {
            // Create file element
            const fileItem = document.createElement('li');
            fileItem.className = 'tree-item tree-file';
            
            const fileIcon = document.createElement('span');
            fileIcon.className = 'file-icon';
            
            const fileName = document.createElement('span');
            fileName.textContent = itemName;
            
            fileItem.appendChild(fileIcon);
            fileItem.appendChild(fileName);
            
            // Add click handler to open the file
            fileItem.addEventListener('click', function(event) {
              event.stopPropagation();
              parent.ChangeSiteSubpage(itemPath, itemName);
            });
            
            fileElements.push(fileItem);
          }
        }
        
        // Add folders first, then files
        folderElements.forEach(({ folderItem, folderContent }) => {
          parentElement.appendChild(folderItem);
          parentElement.appendChild(folderContent);
        });
        
        fileElements.forEach(fileItem => {
          parentElement.appendChild(fileItem);
        });
      } catch (error) {
        console.error('Error building tree node:', error);
      }
    }
    
    // Initialize when the document is loaded
    document.addEventListener('DOMContentLoaded', initFileExplorer);
    
    // Function to scale font sizes for all elements
    function Scale(scale) {
      document.querySelectorAll('.tree-item').forEach(item => {
        item.style.fontSize = 16 * scale + 'px';
      });
    }
  </script>
</body>
</html>