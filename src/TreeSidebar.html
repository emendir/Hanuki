<!DOCTYPE html>

<head>
  <style>
    body {
      /* font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; */
      margin: 0;
      padding: 10px;
      color: #333;
    }

    #explorer {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .tree-item {
      padding: 3px 0;
      margin: 2px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .tree-folder {
      font-weight: 500;
    }

    /* Aligning both files and folders to the same left margin */
    .tree-folder,
    .tree-file {
      margin-left: 0;
    }

    .tree-folder-content {
      border-left: 1px solid #ccc;
      margin-left: 8px;
      padding-left: 14px;
      display: none;
    }

    .tree-folder-content.active {
      display: block;
    }

    .folder-icon,
    .file-icon {
      display: inline-block;
      width: 14px;
      height: 14px;
      margin-right: 5px;
      text-align: center;
    }

    .folder-icon:before {
      content: 'â–¶';
      font-size: 12px;
    }

    .folder-icon.expanded:before {
      content: 'â–¼';
    }

    .file-icon:before {
      /* content: 'ðŸ“„'; */
      content: 'â€”';
      font-size: 12px;
      opacity: 0.6;
    }

    /* Hover effect for items */
    .tree-item:hover {
      background-color: rgba(0, 0, 0, 0.05);
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <div id="file-explorer">
    <ul id="explorer" class="tree-root"></ul>
  </div>

  <script>
    // Main function to initialize the tree
    async function initFileExplorer() {
      const rootElement = document.getElementById('explorer');
      console.log("Initialising file explorer.");
      try {
        // Start building the tree from the ProjectFiles directory
        const tree = await buildTreeNode('/');
        console.log(tree)
        // tree.classList.add("active");
        tree.folderContent.classList.remove("tree-folder-content");
        rootElement.appendChild(tree.folderContent);
        tree.folderContent.classList.add('active');
      } catch (error) {
        console.error('Error initializing file explorer:', error);
      }
    }

    // Function to build a tree node and its children recursively
    async function buildTreeNode(dirPath) {
      try {
        var basename = dirPath.substring(dirPath.lastIndexOf('/') + 1);
        if (basename == "")
        basename = "/";
        // Call the parent window's listProjectDir function
        const subPaths = await parent.listProjectDir(dirPath);
        if (!subPaths || subPaths.length === 0) {
          // Create file element
          const fileItem = document.createElement('li');
          fileItem.className = 'tree-item tree-file';

          const fileIcon = document.createElement('span');
          fileIcon.className = 'file-icon';

          const fileName = document.createElement('span');
          fileName.textContent = basename;

          fileItem.appendChild(fileIcon);
          fileItem.appendChild(fileName);

          // Add click handler to open the file
          fileItem.addEventListener('click', function(event) {
            event.stopPropagation();
            parent.ChangeSiteSubpage(`${dirPath}`, basename);
          });
          console.log("Returning:");
          console.log(fileItem)
          return fileItem;
        }


        // Process each item using the new IPFS metadata
        var fileElements = [];
        var folderElements = [];
        for (const subPath of subPaths) {
          // console.log(subPath)
          if (subPath.Name == "/" || subPath.Name == "" || subPath.Name == ".")
            continue
          const subItem = await buildTreeNode(`${dirPath}/${subPath.Name}`);
          if (subItem) {
            if (subItem.classList.contains('tree-file')) {
              fileElements.push(subItem);
            }
            else if (subItem.classList.contains('tree-folder')) {
              folderElements.push(subItem);
            }
            else{
              console.log("SKIPPING");
              console.log(subItem);
            }
          }
        }
        
        
        // this path is a folder

        // Create containers for folders and files so we can display folders first
        // Create folder element
        const folderItem = document.createElement('li');
        folderItem.className = 'tree-item tree-folder';

        const folderIcon = document.createElement('span');
        folderIcon.className = 'folder-icon';

        const folderName = document.createElement('span');
        folderName.textContent = basename;

        folderItem.appendChild(folderIcon);
        folderItem.appendChild(folderName);
        
  
        // Create a container for folder contents
        const folderContent = document.createElement('ul');
        folderContent.dataset.loaded = 'true';
        folderContent.className = 'tree-folder-content';
        // folderItem.appendChild(folderContent);

        // Add click handler to toggle folder expansion
        folderItem.addEventListener('click', function(event) {
          event.stopPropagation();
          folderIcon.classList.toggle('expanded');
          folderContent.classList.toggle('active');
        });
        
        // Add folders first, then files
        for(const item of folderElements) {
          folderContent.appendChild(item);
        }
        for(const item of fileElements) {
          folderContent.appendChild(item);
        }
        
        const folderall = document.createElement('span');
        folderall.className="tree-folder";
        folderall.appendChild(folderItem);
        folderall.appendChild(folderContent);
        folderall.folderContent = folderContent;
        
        

        console.log("Built tree!");
        return folderall;
      } catch (error) {
        console.error('Error building tree node:', error);
        return null;
      }
    }

    // Initialize when the document is loaded
    document.addEventListener('DOMContentLoaded', initFileExplorer);

    // Function to scale font sizes for all elements
    function Scale(scale) {
      document.querySelectorAll('.tree-item').forEach(item => {
        item.style.fontSize = 16 * scale + 'px';
      });
    }
  </script>
</body>

</html>