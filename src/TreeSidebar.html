<!DOCTYPE html>

<head>
  <style>
    body {
      /* font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; */
      margin: 0;
      padding: 10px;
      color: #333;
    }

    #explorer {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .tree-item {
      padding: 3px 0;
      margin: 2px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .tree-folder {
      font-weight: 500;
    }

    /* Aligning both files and folders to the same left margin */
    .tree-folder,
    .tree-file {
      margin-left: 0;
    }

    /* Folder container styling */
    .folder-container {
      list-style: none;
    }

    .tree-folder-content {
      border-left: 1px solid #ccc;
      margin-left: 8px;
      padding-left: 14px;
      display: none;
    }

    .tree-folder-content.active {
      display: block;
    }

    .folder-icon,
    .file-icon {
      display: inline-block;
      width: 14px;
      height: 14px;
      margin-right: 5px;
      text-align: center;
    }

    .folder-icon:before {
      content: 'â–¶';
      font-size: 12px;
    }

    .folder-icon.expanded:before {
      content: 'â–¼';
    }

    .file-icon:before {
      /* content: 'ðŸ“„'; */
      content: 'â€”';
      font-size: 12px;
      opacity: 0.6;
    }

    /* Hover effect for items */
    .tree-item:hover {
      background-color: rgba(0, 0, 0, 0.05);
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <div id="file-explorer">
    <ul id="explorer" class="tree-root"></ul>
  </div>

  <script>
    // Main function to initialize the tree
    async function initFileExplorer() {
      const rootElement = document.getElementById('explorer');
      console.log("Initialising file explorer.");
      try {
        // Create the root folder (ProjectFiles)
        const rootName = '/';

        // Start by only loading the root level
        const rootPaths = await parent.listProjectDir(rootName);
        console.log(rootPaths);
        // Create the root container which will be visible initially
        const rootContainer = document.createElement('ul');
        rootContainer.classList.add('active');
        rootContainer.subPaths = rootPaths;
        rootContainer.dataset.path = rootName;

        // Populate only the root level initially
        await loadFolderContent(rootContainer, rootName);

        // Add to the explorer
        rootElement.appendChild(rootContainer);
      } catch (error) {
        console.error('Error initializing file explorer:', error);
      }
    }

    // Function to create a file node
    function createFileNode(path, name) {
      const fileItem = document.createElement('li');
      fileItem.className = 'tree-item tree-file';
      
      const fileIcon = document.createElement('span');
      fileIcon.className = 'file-icon';
      
      const fileName = document.createElement('span');
      fileName.textContent = name;
      
      fileItem.appendChild(fileIcon);
      fileItem.appendChild(fileName);
      
      // Add click handler to open the file
      fileItem.addEventListener('click', function(event) {
        event.stopPropagation();
        parent.ChangeSiteSubpage(path, name);
      });
      
      return fileItem;
    }
    
    // Function to create a folder node
    function createFolderNode(path, name, subPaths) {
      // Create the list item that will contain both the folder and its content
      const folderContainer = document.createElement('li');
      folderContainer.className = 'folder-container';

      // Create the folder item itself
      const folderItem = document.createElement('div');
      folderItem.className = 'tree-item tree-folder';
      folderItem.dataset.path = path;

      // Add folder icon
      const folderIcon = document.createElement('span');
      folderIcon.className = 'folder-icon';

      // Add folder name
      const folderName = document.createElement('span');
      folderName.textContent = name;

      folderItem.appendChild(folderIcon);
      folderItem.appendChild(folderName);

      // Create a container for folder contents
      const folderContent = document.createElement('ul');
      folderContent.dataset.loaded = 'false';
      folderContent.className = 'tree-folder-content';

      folderContent.dataset.path = path;
      folderContent.subPaths = subPaths;
      
      // Add click handler to toggle folder expansion and load content if needed
      folderItem.addEventListener('click', async function(event) {
        event.stopPropagation();
        folderIcon.classList.toggle('expanded');
        folderContent.classList.toggle('active');

        // If folder content isn't loaded yet, load it
        if (folderContent.dataset.loaded === 'false') {
          await loadFolderContent(folderContent);
          folderContent.dataset.loaded = 'true';
        }
      });

      // Add both elements to the container
      folderContainer.appendChild(folderItem);
      folderContainer.appendChild(folderContent);
      folderContainer.folderContent = folderContent;

      return folderContainer;
    }
    
    // Function to load content for a folder
    async function loadFolderContent(folderContainer) {
      // Process each item
      var fileElements = [];
      var folderElements = [];
      console.log(`Loading folder content: ${folderContainer.dataset.path}`)
      console.log(folderContainer.subPaths)
      for (const subPath of folderContainer.subPaths) {
        console.log(`Subpth: ${subPath.Name} : ${subPath}`)
        console.log(subPath);
        if (subPath.Name == "/" || subPath.Name == "" || subPath.Name == ".")
          continue;
          
        const fullPath = `${folderContainer.dataset.path}/${subPath.Name}`;
        const subPaths = await parent.listProjectDir(fullPath);
        const isFile = subPaths.length == 0;
        
        if (isFile) {
          // Create file node
          const fileNode = createFileNode(fullPath, subPath.Name);
          fileElements.push(fileNode);
        } else {
          // Create folder node without loading its contents yet
          const folderNode = createFolderNode(fullPath, subPath.Name, subPaths);
          folderElements.push(folderNode);
        }
      }
      
      // Add folders first, then files
      for (const item of folderElements) {
        folderContainer.appendChild(item);
      }
      for (const item of fileElements) {
        folderContainer.appendChild(item);
      }
      
      return folderContainer;
    }

    // Initialize when the document is loaded
    document.addEventListener('DOMContentLoaded', initFileExplorer);

    // Function to scale font sizes for all elements
    function Scale(scale) {
      document.querySelectorAll('.tree-item').forEach(item => {
        item.style.fontSize = 16 * scale + 'px';
      });
    }
  </script>
</body>

</html>